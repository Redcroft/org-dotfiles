#+TITLE: Email Config
#+AUTHOR: Richard Redcroft
#+EMAIL: Richard@Redcroft.tech
#+OPTIONS: toc:nil num:nil
#+PROPERTY: Header-args :tangle-mode (identity #o444) :mkdirp yes
#+auto_tangle: t

* Isync
** Create Dirs
#+begin_src emacs-lisp :tangle no :results none
  (make-directory (expand-file-name "~/.mail"))
  (make-directory (expand-file-name "~/.mail/redcroft"))
  (make-directory (expand-file-name "~/.mail/work"))
  (make-directory (expand-file-name "~/.mail/gmail"))
#+end_src


** Redcroft
#+begin_src conf :tangle "~/.mbsyncrc"
  IMAPAccount redcroft
  Host imap.hostinger.com
  User richard@redcroft.tech
  #PassCmd "bw get password hostinger.com richard@redcroft.tech"
  PassCmd "gpg2 -q --for-your-eyes-only --no-tty -d ~/.repos/org-dotfiles/mail/redcroft.gpg"
  TLSType IMAPS
  CertificateFIle /etc/ssl/certs/ca-certificates.crt

  IMAPStore redcroft-remote
  Account redcroft

  MaildirStore redcroft-local
  SubFolders Verbatim
  Path ~/.mail/redcroft/
  Inbox ~/.mail/redcroft/Inbox

  Channel Redcroft
  Far :redcroft-remote:
  Near :redcroft-local:
  Patterns *
  Create Both
  Expunge Both
  SyncState *
#+end_src

** Work
#+begin_src conf :tangle "~/.mbsyncrc"
  IMAPAccount work
  Host imap.gmail.com
  User richard@carseandwaterman.com
  #PassCmd "bw get password hostinger.com richard@work.tech"
  PassCmd "gpg2 -q --for-your-eyes-only --no-tty -d ~/.repos/org-dotfiles/mail/work.gpg"
  AuthMechs LOGIN
  TLSType IMAPS
  CertificateFIle /etc/ssl/certs/ca-certificates.crt

  IMAPStore work-remote
  Account work

  MaildirStore work-local
  SubFolders Verbatim
  Path ~/.mail/work/
  Inbox ~/.mail/work/Inbox

  Channel Work
  Far :work-remote:
  Near :work-local:
  Patterns * ![Gmail]/All* ![Gmail]/Spam
  Create Both
  Expunge Both
  SyncState *
#+end_src

** Gmail
#+begin_src conf :tangle "~/.mbsyncrc"
  IMAPAccount gmail
  Host imap.gmail.com
  User animationrich@gmail.com
  #PassCmd "bw get password hostinger.com richard@gmail.tech"
  PassCmd "gpg2 -q --for-your-eyes-only --no-tty -d ~/.repos/org-dotfiles/mail/gmail.gpg"
  AuthMechs LOGIN
  TLSType IMAPS
  CertificateFIle /etc/ssl/certs/ca-certificates.crt

  IMAPStore gmail-remote
  Account gmail

  MaildirStore gmail-local
  SubFolders Verbatim
  Path ~/.mail/gmail/
  Inbox ~/.mail/gmail/Inbox

  Channel Gmail
  Far :gmail-remote:
  Near :gmail-local:
  Patterns * ![Gmail]/All* ![Gmail]/Spam
  Create Both
  Expunge Both
  SyncState *
#+end_src

** Msmtp
#+begin_src conf :tangle "~/.msmtprc"
  # Set default values for all following accounts.
  defaults
  auth             on
  tls              on
  tls_trust_file   /etc/ssl/certs/ca-certificates.crt
  logfile          ~/.msmtp.log

  # Redcroft
  account          redcroft
  host             smtp.hostinger.com
  port             465
  tls_starttls     off
  from             richard@redcroft.tech
  user             richard@redcroft.tech
  passwordeval     "gpg2 -q --for-your-eyes-only --no-tty -d ~/.repos/org-dotfiles/mail/redcroft.gpg"

  # Work Gmail
  account          work
  host             smtp.gmail.com
  port             587
  from             richard@carseandwaterman.com
  user             richard@carseandwaterman.com
  passwordeval     "gpg2 -q --for-your-eyes-only --no-tty -d ~/.repos/org-dotfiles/mail/work.gpg"

  # Personal Gmail
  account          gmail
  host             smtp.gmail.com
  port             587
  from             animationrich@gmail.com
  user             animationrich@gmail.com
  passwordeval     "gpg2 -q --for-your-eyes-only --no-tty -d ~/.repos/org-dotfiles/mail/gmail.gpg"

  # Set a default account
  account default : redcroft
#+end_src
** Systemd
#+begin_src systemd :tangle "~/.config/systemd/user/mbsync.service"
  [Unit]
  Description=Mailbox sync service

  [Service]
  Type=oneshot
  ExecStart=%h/.local/bin/mail-sync

  [Install]
  WantedBy=default.target
#+end_src

#+begin_src systemd :tangle "~/.config/systemd/user/mbsync.timer"
  [Unit]
  Description=Mailbox sync TimerSlackNSec

  [Timer]
  OnBootSec=2m
  OnUnitActiveSec=5m
  Unit=mbsync.service

  [Install]
  WantedBy=timers.target
#+end_src
 

#+begin_src sh :tangle "~/.local/bin/mail-sync" :tangle-mode (identity #o777)
  #!/bin/bash
  mbsync -Va
  mu index
#+end_src

#+begin_src sh :tangle no :results none
  mbsync -a
  mu init --maildir=~/.mail --personal-address=richard@redcroft.tech --personal-address=animationrich@gmail.com --personal-address=richard@carseandwaterman.com
  mu index
  systemctl --user enable --now mbsync.timer
#+end_src
