#+TITLE: Qutebrowser Configuration
#+AUTHOR: Richard Redcroft
#+EMAIL: Richard@Redcroft.tech
#+OPTIONS: toc:nil num:nil
#+PROPERTY: Header-args :tangle-mode (identity #o444) :mkdirp yes
#+auto_tangle: t

* Config
** Theme
#+NAME: base16-theme
#+begin_src sh :tangle no :results none
  curl -fsSL --create-dirs -o ~/.config/qutebrowser/theme.py https://raw.githubusercontent.com/theova/base16-qutebrowser/master/themes/default/base16-horizon-dark.config.py
#+end_src

#+begin_src python :tangle "~/.config/qutebrowser/config.py" :noweb yes
  #<<base16-theme()>>
  config.load_autoconfig()
  config.source("theme.py")
#+end_src

** Settings
#+begin_src python :tangle "~/.config/qutebrowser/config.py"
  c.auto_save.session = True
  c.completion.shrink = True
  c.content.notifications.enabled = True
  c.content.blocking.whitelist = ["youtube.com"]
  c.downloads.location.prompt = False
  c.scrolling.smooth = False
  c.window.title_format = "qutebrowser"
  c.hints.chars = "arstneio"
  c.url.searchengines = {
      'DEFAULT':  'https://duckduckgo.com/search?q={}',
      'az': 'https://www.amazon.co.uk/s?k={}',
      'g':  'https://google.com/search?hl=en&q={}',
      'yt': 'https://youtube.com/results?search_query={}',
      'yti': 'https://yewtu.be/search?q={}'
  }

  c.colors.webpage.preferred_color_scheme = "dark"
  c.colors.webpage.darkmode.enabled = False
  c.colors.webpage.darkmode.policy.images = "smart-simple"
  c.fonts.default_family = ["Gohu GohuFont"]

  config.bind("<Ctrl-tab>", "tab-next")
  config.bind("<Ctrl-Shift-tab>", "tab-prev")
  config.bind("m", "spawn mpv --hwdec=auto --ytdl-format=bestvideo[height<=?720]+bestaudio/best {url}")
  config.bind("M", "hint links spawn mpv --hwdec=auto --ytdl-format=bestvideo[height<=?720]+bestaudio/best {hint-url}")
  config.bind("<z><l>", "spawn --userscript qute-rbw")
  config.bind("<z><u>", "spawn --userscript qute-rbw --username-only")
  config.bind("<z><p>", "spawn --userscript qute-rbw --password-only")
  config.bind("<Ctrl-f>", "scroll right")
  config.bind("<Ctrl-b>", "scroll left")
  config.bind("<Ctrl-n>", "scroll down")
  config.bind("<Ctrl-p>", "scroll up")
  config.bind("<z><r>", "config-source ~/.config/qutebrowser/config.py")
#+end_src

* Quickmarks
#+begin_src text :tangle "~/.config/qutebrowser/quickmarks"
  asdf https://asdf-vm.com/guide/introduction.html
  cg https://www.cgchannel.com/
  chat https://chat.carseandwaterman.com
  gmail https://gmail.com
  git https://git.carseandwaterman.com
  gol https://gamingonlinux.com
  homerow https://github.com/stasmarkin/sm_td
  hotuk https://hotukdeals.com
  lisp https://gigamonkeys.com/book
  mail https://mail.hostinger.com
  mise https://mise.jdx.dev/dev-tools/comparison-to-asdf.html
  phoronix https://phoronix.com
  prime https://amazon.co.uk/gp/video/storefront
  psx https://www.willsconsolemodifications.co.uk/index.php?route=product/product&language=en-gb&path=61_65&product_id=82
  raylib-cpp https://robloach.github.io/raylib-cpp/namespaces.html
  raylib-cs https://www.raylib.com/cheatsheet/cheatsheet.html
  reddit https://reddit.com
  roswell https://roswell.github.io/Roswell-as-a-Scripting-Environment.html
  rust https://fasterthanli.me/articles/a-half-hour-to-learn-rust
  yt https://youtube.com/feed/subscriptions
#+end_src

* Qute-rbw
#+begin_src python :tangle "~/.local/share/qutebrowser/userscripts/qute-rbw" :tangle-mode (identity #o755)
  #!/usr/bin/env python3

  # Copyright 2017 Chris Braun (cryzed) <cryzed@googlemail.com>
  # Adapted for rbw by Marek Bogusovsky (proxict) <marek.bogusovsky@protonmail.com>,
  # Adapted for rbw unlock by Wings Zeng (WingsZeng) <wings.xiangyi.zeng@gmail.com>
  # Jiri Kozusznik (JKPaladin) <jirkakozusznik@seznam.cz>
  #
  # This file is part of qutebrowser.
  #
  # qutebrowser is free software: you can redistribute it and/or modify
  # it under the terms of the GNU General Public License as published bjy
  # the Free Software Foundation, either version 3 of the License, or
  # (at your option) any later version.
  #
  # qutebrowser is distributed in the hope that it will be useful,
  # but WITHOUT ANY WARRANTY; without even the implied warranty of
  # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  # GNU General Public License for more details.
  #
  # You should have received a copy of the GNU General Public License
  # along with qutebrowser.  If not, see <https://www.gnu.org/licenses/>.

  """
  Insert login information using rbw CLI and a dmenu-compatible application
  (e.g. dmenu, rofi -dmenu, ...).
  """

  from __future__ import annotations

  import argparse
  import json
  import os
  import shlex
  import subprocess
  import sys

  from dataclasses import dataclass
  from enum import Enum, IntEnum, unique
  from io import TextIOWrapper
  from types import TracebackType

  import tldextract

  argument_parser = argparse.ArgumentParser(
      description=__doc__,
  )
  argument_parser.add_argument("url", nargs="?", default=os.getenv("QUTE_URL"))
  argument_parser.add_argument("--folder", "-f", default=None, help="Specify folder to search for the credentials")
  argument_parser.add_argument(
      "--terminal",
      "-t",
      default="kitty",
      help="Terminal used to execute rbw unlock",
  )
  argument_parser.add_argument(
      "--dmenu-invocation",
      "-d",
      default="rofi -dmenu -i -p Bitwarden",
      help="Invocation used to execute a dmenu-provider",
  )
  argument_parser.add_argument(
      "--no-insert-mode",
      "-n",
      dest="insert_mode",
      action="store_false",
      help="Don't automatically enter insert mode",
  )
  argument_parser.add_argument(
      "--io-encoding",
      "-i",
      default="UTF-8",
      help="Encoding used to communicate with subprocesses",
  )
  group = argument_parser.add_mutually_exclusive_group()
  group.add_argument("--username-only", "-e", action="store_true", help="Only insert username")
  group.add_argument("--password-only", "-w", action="store_true", help="Only insert password")


  @unique
  class ExitCodes(IntEnum):
      """Represents process exit codes"""

      SUCCESS = 0
      FAILURE = 1


  class QuteFifo:
      """Pipe for writing commands to qutebrowser"""

      def __init__(self, encoding: str) -> None:
          self.fifo: TextIOWrapper | None = None
          self.encoding = encoding

      def __enter__(self) -> QuteFifo:
          self.fifo = open(os.environ["QUTE_FIFO"], "w", encoding=self.encoding)
          return self

      def __exit__(
          self,
          _exc_type: type[BaseException] | None,
          _exc_val: BaseException | None,
          _exc_tb: TracebackType | None,
      ) -> None:
          if self.fifo:
              self.fifo.close()

      def command(self, command: str) -> None:
          """Executes the given command in qutebrowser"""
          if not self.fifo:
              raise RuntimeError("FIFO not open")
          self.fifo.write(command + "\n")
          self.fifo.flush()

      def fake_key(self, text: str) -> None:
          """Fakes a key-press in qutebrowser"""
          for key in text:
              # Escape all characters by default, space requires special handling
              sequence = '" "' if key == " " else f"\\{key}"
              self.command(f"fake-key {sequence}")

      def message_error(self, text: str) -> None:
          """Shows an error-message in qutebrowser"""
          self.command(f"message-error '{text}'")

      def message_info(self, text: str) -> None:
          """Shows an info-message in qutebrowser"""
          self.command(f"message-info '{text}'")

      def message_warning(self, text: str) -> None:
          """Shows a warning-message in qutebrowser"""
          self.command(f"message-warning '{text}'")


  def rbw_get(args: list[str]) -> list[str] | tuple[str, str]:
      """
      Gets login credentials for the given domain

              Parameters:
                      args: The following command arguments

              Returns:
                      A tuple containing username and password, or a list of possible usernames for
                      whom there were credentials found for the given domain.
      """
      args = ["rbw", "get", "--raw"] + args
      process = subprocess.run(
          args,
          check=False,
          stdout=subprocess.PIPE,
          stderr=subprocess.PIPE,
      )

      if err := process.stderr.decode(arguments.io_encoding).strip():
          if err.endswith("no entry found"):
              return []

          multiple_entries_str = ": multiple entries found: "
          if (pos := err.find(multiple_entries_str)) != -1:
              usernames = err[pos + len(multiple_entries_str) :].split(", ")
              return [u.rpartition("@")[0] for u in usernames]

          raise RuntimeError(f"rbw failed: {err}")

      if credentials_data := json.loads(process.stdout.decode(arguments.io_encoding).strip()).get("data"):
          return credentials_data.get("username"), credentials_data.get("password")

      raise RuntimeError("Unexpected json output from rbw")


  def rbw_list() -> list[str]:
      """List all items."""
      args = ["rbw", "list"]
      process = subprocess.run(
          args,
          check=False,
          stdout=subprocess.PIPE,
          stderr=subprocess.PIPE,
      )
      return process.stdout.decode(arguments.io_encoding).splitlines()


  def dmenu(items: list[str]) -> str:
      """Runs dmenu with given arguments."""
      print(arguments.dmenu_invocation)
      process = subprocess.run(
          shlex.split(arguments.dmenu_invocation),
          input="\n".join(items).encode(arguments.io_encoding),
          check=False,
          stdout=subprocess.PIPE,
      )
      return process.stdout.decode(arguments.io_encoding).strip()


  @unique
  class MessageType(Enum):
      """Represents message type"""

      ERROR = 0
      INFO = 1


  @dataclass
  class Message:
      """Represents a string of a given type"""

      message: str
      message_type: MessageType


  def rbw_get_credential(args: list[str]) -> tuple[str, str]:
      """
      A wrapper of rbw_get, retrieves a single credential using the provided arguments.

              Parameters:
                      args: The following command arguments

              Returns:
                      A tuple containing username and password
      """
      try:
          credential = rbw_get(args)
      except (RuntimeError, OSError) as err:
          return Message(str(err), MessageType.ERROR)
      if not isinstance(credential, tuple):
          return Message("Unexpected: multiple results encountered", MessageType.ERROR)
      return credential


  def get_credential(uri: str) -> tuple[str, str]:
      """
      Gets login credentials for the given domain

              Parameters:
                      uri: The uri to get the credential for

              Returns:
                      A tuple containing username and password, or a list of possible usernames for
                      whom there were credentials found for the given domain.
      """
      extract_result = tldextract.extract(arguments.url)
      scheme = ("https" if arguments.url.startswith("https") else "http") + "://"

      uri_candidates = [extract_result.fqdn, extract_result.registered_domain, extract_result.domain]
      targets = [scheme + candidate for candidate in uri_candidates if candidate]
      if extract_result.ipv4:
          targets.append(extract_result.ipv4)

      for target in targets:
          try:
              credentials = rbw_get([target])
          except (RuntimeError, OSError) as err:
              return Message(str(err), MessageType.ERROR)

          if isinstance(credentials, tuple):  # We found exactly one match, return it immediately
              return credentials
          if isinstance(credentials, list):  # We either found multiple or no credentials
              # If no credentials were found for this target, continue searching in other targets
              if not credentials:
                  continue
              # For multiple matches, let the user decide which one to fill, if any
              if not (username := dmenu(credentials)):
                  return Message("Canceled by user", MessageType.INFO)

              return rbw_get_credential([uri, username])

      # If no credentials were found for all targets, display a dmenu with all items for the user to choose from
      if not (name := dmenu(rbw_list())):
          return Message("Canceled by user", MessageType.INFO)
      return rbw_get_credential([name])


  def try_unlock() -> bool:
      if subprocess.run(['rbw', 'unlocked'], stderr=subprocess.DEVNULL).returncode != 0:
          subprocess.run([arguments.terminal, '--title', 'rbw', 'rbw', 'unlock'])
      return subprocess.run(['rbw', 'unlocked'], stderr=subprocess.DEVNULL).returncode == 0


  def main() -> int:
      """main"""
      if not arguments.url:
          argument_parser.print_help()
          return ExitCodes.FAILURE

      with QuteFifo(arguments.io_encoding) as fifo:
          if not try_unlock():
              fifo.message_info('rbw unlock failed!')
              return ExitCodes.SUCCESS
          credential = get_credential(uri=arguments.url)
          if isinstance(credential, Message):
              if credential.message_type == MessageType.ERROR:
                  fifo.message_error(credential.message)
                  return ExitCodes.FAILURE

              fifo.message_info(credential.message)
              return ExitCodes.SUCCESS

          username, password = credential

          if arguments.username_only:
              fifo.fake_key(username)
          elif arguments.password_only:
              fifo.fake_key(password)
          else:
              fifo.fake_key(username)
              fifo.command("fake-key <Tab>")
              fifo.fake_key(password)

          if arguments.insert_mode:
              fifo.command("mode-enter insert")

      return ExitCodes.SUCCESS


  if __name__ == "__main__":
      arguments = argument_parser.parse_args()
      sys.exit(main())
#+end_src

* Adblock
#+begin_src javascript :tangle no :tngle "~/.local/share/qutebrowser/greasemonkey/yt-adblock.js" :tangle-mode (identity #o755)
  // ==UserScript==
  // @name         YouTube Ad-Blocker (uBlock layout)
  // @version      2.7
  // @description  Hides ads and bypasses the 'adblock detected' popup
  // @author       Communist (Fedora-user) 
  // @match        https://www.youtube.com/*
  // @grant        none
  // @run-at       document-start
  // @updateURL    https://codeberg.org/Huegochrome/RiverWM-Fedora-Minimal/raw/branch/main/config/qutebrowser/greasemonkey/ytuser.js
  // @downloadURL  https://codeberg.org/Huegochrome/RiverWM-Fedora-Minimal/raw/branch/main/config/qutebrowser/greasemonkey/ytuser.js
  // ==/UserScript==

  (function() {
      const css = `
          ytd-ad-slot-renderer, 
          ytd-pyv-ad-renderer, 
          ytd-promoted-sparkles-web-renderer, 
          .ytd-item-section-renderer:has(ytd-ad-slot-renderer),
          ytd-rich-item-renderer:has(ytd-ad-slot-renderer),
          #masthead-ad, 
          .video-ads, 
          .ytp-ad-module, 
          tp-yt-paper-dialog:has(#enforcement-message) { 
              display: none !important; 
          }
      `;
      const style = document.createElement('style');
      style.appendChild(document.createTextNode(css));
      
      const checkAndAppend = () => {
          const target = document.head || document.documentElement;
          if (target) {
              target.appendChild(style);
          } else {
              requestAnimationFrame(checkAndAppend);
          }
      };
      checkAndAppend();

      // VIDEO AD SKIPPING
      setInterval(() => {
          const video = document.querySelector('video');
          const ad = document.querySelector('.ad-showing, .ad-interrupting');
          if (ad && video) {
              video.currentTime = video.duration;
              document.querySelectorAll('[class*="skip-button"]').forEach(btn => btn.click());
          }
      }, 100);

      // VERSION LOG
      console.log("%c YouTube Ad-Blocker Updated! %c Version 2.7 is now active.", 
                  "color: white; background: #cc0000; font-weight: bold; border-radius: 5px; padding: 2px 5px;", 
                  "color: #cc0000; font-weight: bold;");
  })();
#+end_src

* Skip YT Thumbnail play
#+begin_src js :tangle "~/.local/share/qutebrowser/greasemonkey/yt-thumbs.js" :tangle-mode (identity #o755)
  // ==UserScript==
  // @name         YouTube - Block Autoplay Preview Thumbnail and Channel Trailer
  // @description         Blocks YouTube thumbnail hover previews (WebP & video) and stops channel trailers (video + audio). Keeps progress bars, play buttons, and static images. Works on all pages, no login or permissions needed, runs at document-start.
  // @namespace    https://openuserjs.org/users/miebie.1412
  // @author       miebie.1412
  // @version      1.1.5
  // @match        https://*.youtube.com/*
  // @grant        none
  // @run-at       document-start
  // @license      MIT
  // @homepageURL  https://openuserjs.org/users/miebie.1412
  // @supportURL   https://openuserjs.org/scripts/miebie.1412/YouTube_-_Block_Autoplay_Preview_Thumbnail_and_Channel_Trailer/issues
  // @icon         https://www.google.com/s2/favicons?sz=64&domain=youtube.com
  // @updateURL    https://openuserjs.org/meta/miebie.1412/YouTube_-_Block_Autoplay_Preview_Thumbnail_and_Channel_Trailer.meta.js
  // @downloadURL  https://openuserjs.org/install/miebie.1412/YouTube_-_Block_Autoplay_Preview_Thumbnail_and_Channel_Trailer.user.js
  // ==/UserScript==
  !function(){'use strict';const processed=new WeakSet;let lastScrollY=0;const style=document.createElement('style');style.textContent="\n    body:not([page-type=\"watch\"]) ytd-moving-thumbnail-renderer,\n        body:not([page-type=\"watch\"]) .ytd-moving-thumbnail-renderer,\n        .ytp-cued-thumbnail-overlay,\n        .ytp-cued-thumbnail-overlay-image,\n        ytd-thumbnail-overlay-loading-preview-renderer,\n        .ytd-thumbnail-overlay-loading-preview-renderer,\n        ytd-video-preview:not(#player-container ytd-video-preview),\n        .ytd-video-preview:not(#player-container .ytd-video-preview),\n        #thumbnail-overlay-play:not(#player-container #thumbnail-overlay-play),\n        .thumbnail-overlay-play:not(#player-container .thumbnail-overlay-play),\n        #video-preview-container:not(#player-container #video-preview-container),\n        .video-preview-container:not(#player-container .video-preview-container),\n        ytd-channel-video-player-renderer,\n        #c4-player,\n        ytd-player[context*=\"CHANNEL_TRAILER\"] {\n            display: none !important;\n            visibility: hidden !important;\n            height: 0 !important;\n            width: 0 !important;\n            overflow: hidden !important;\n            pointer-events: none !important;\n        }\n        #movie-player #player img,\n        .html5-main-video-container img,\n        ytd-watch-flexy #thumbnail img {\n            display: block !important;\n            visibility: visible !important;\n            opacity: 1 !important;\n        }\n        ytd-thumbnail img,\n        .ytd-thumbnail img {\n            transition: none !important;\n            opacity: 1 !important;\n        }\n        #overlays,\n        .ytd-rich-item-renderer #overlays,\n        ytd-thumbnail[has-inline-playback-button] #overlays,\n        ytd-thumbnail-overlay-toggle-pause-renderer,\n        .ytd-thumbnail-overlay-toggle-pause-renderer {\n            all: unset !important;\n            display: block !important;\n        }\n    ",(document.head||document.documentElement).appendChild(style);const blockAudio=()=>{document.querySelector('ytd-recorder, [data-recorder-active], [id*="recorder"], .recorder-active')||['AudioContext','webkitAudioContext'].forEach(name=>{if(window[name]&&!window[name].prototype._blocked){const AC=window[name];AC.prototype._blocked=!0;const dummy={connect:()=>{},disconnect:()=>{}};AC.prototype.createMediaElementSource=()=>dummy,AC.prototype.resume=()=>Promise.resolve()}})};blockAudio(),setInterval(blockAudio,200);const isTrailer=el=>el.closest('ytd-channel-video-player-renderer')||'c4-player'===el.id||'YTD-PLAYER'===el.tagName&&el.getAttribute('context')&&el.getAttribute('context').includes('CHANNEL_TRAILER'),killVideo=video=>{if(video&&!video._killed&&!(video=>location.pathname.startsWith('/watch')&&(video.closest('ytd-watch-flexy')||video.closest('#ytd-player')||video.classList.contains('html5-main-video')))(video)){video.src&&video.src.startsWith('blob:')&&URL.revokeObjectURL(video.src),video.pause(),video.muted=!0,video.volume=0,video.currentTime=0,video.src='',video.removeAttribute('src');try{video.load()}catch(e){}video._killed=!0}},blockAll=()=>{document.querySelectorAll('img[src*="an_webp"], video[src*="an_webp"], img[src*="avif"], video[src*="avif"], img[src*="video-preview"], video[src*="video-preview"]').forEach(el=>{'IMG'===el.tagName?(el.src=el.src.replace(/an_webp\/[^&]*&/g,'').replace(/avif\/[^&]*&/g,'').replace(/video-preview\/[^&]*&/g,''),el.srcset=''):'VIDEO'===el.tagName&&(el.src=el.src.replace(/an_webp\/[^&]*&/g,'').replace(/avif\/[^&]*&/g,'').replace(/video-preview\/[^&]*&/g,''),el.pause(),el.currentTime=0,el.removeAttribute('autoplay'))}),location.pathname.startsWith('/watch')||(document.querySelectorAll('video').forEach(v=>{isTrailer(v)&&killVideo(v)}),document.querySelectorAll('ytd-channel-video-player-renderer, #c4-player, ytd-player').forEach(el=>{if(isTrailer(el)){const vid=el.querySelector('video');vid&&killVideo(vid)}}))};window.blockAll=blockAll;new MutationObserver(blockAll).observe(document.documentElement,{childList:!0,subtree:!0,attributes:!0,attributeFilter:['src','srcset','class','id','context']}),blockAll(),setInterval(blockAll,500);let lastUrl=location.href;function isPostImage(img){if(!img||!img.src)return!1;if(!img.src.includes('ggpht.com')&&!img.src.includes('googleusercontent.com'))return!1;if(!img.closest('ytd-backstage-post-renderer'))return!1;if(!img.closest('#image-container, [id*="image"]'))return!1;const rect=img.getBoundingClientRect();return!(rect.width<=50&&rect.height<=50)&&(!(rect.width>=1e3)&&!img.closest('ytd-rich-grid-media, ytd-video-renderer'))}function freezeImage(img){!processed.has(img)&&isPostImage(img)&&(img.complete&&0!==img.naturalWidth?createCanvas(img):img.addEventListener('load',()=>createCanvas(img),{once:!0}))}function createCanvas(img){if(processed.has(img))return;const canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),w=img.naturalWidth||640,h=img.naturalHeight||480;if(0===w||0===h)return;canvas.width=w,canvas.height=h,ctx.drawImage(img,0,0,w,h);const style=getComputedStyle(img);canvas.style.cssText=img.style.cssText,canvas.style.width=style.width,canvas.style.height=style.height,canvas.style.objectFit='cover',canvas.style.display='block',canvas.style.borderRadius=style.borderRadius,canvas.className=img.className,canvas.alt=img.alt,img.parentNode&&(img.parentNode.replaceChild(canvas,img),processed.add(img),console.log('%cGIF blocked','color:#fff;background:#000;padding:4px 12px;border-radius:6px;font-weight:bold;font-family:monospace;box-shadow:0 0 8px rgba(255,255,255,0.3)',img.src.split('/').pop().split('?')[0]))}function scan(force=!1){document.querySelectorAll('ytd-backstage-post-renderer img').forEach(img=>{!force&&processed.has(img)||freezeImage(img)})}new MutationObserver(()=>{location.href!==lastUrl&&(lastUrl=location.href,setTimeout(blockAll,100))}).observe(document,{subtree:!0,childList:!0}),['pushState','replaceState'].forEach(m=>{const orig=history[m];history[m]=function(){orig.apply(this,arguments),setTimeout(()=>{location.href!==lastUrl&&blockAll()},80)}}),'loading'===document.readyState&&document.addEventListener('DOMContentLoaded',blockAll);const observer=new MutationObserver(mutations=>{let needsScan=!1;for(const m of mutations)'childList'===m.type&&m.addedNodes.length&&(needsScan=!0),'attributes'!==m.type||'src'!==m.attributeName&&'srcset'!==m.attributeName||(needsScan=!0);needsScan&&scan(!0)}),startObserver=()=>observer.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:['src','srcset']});document.body?startObserver():document.addEventListener('DOMContentLoaded',startObserver);const poll=setInterval(scan,300);setTimeout(()=>clearInterval(poll),9e4),document.addEventListener('click',e=>{const arrow=e.target.closest('button[aria-label*="next"], button[aria-label*="previous"], [role="button"][aria-label*="slide"]');arrow&&arrow.closest('ytd-backstage-post-renderer')&&setTimeout(()=>scan(!0),150)},{capture:!0}),document.addEventListener('wheel',e=>{e.deltaY<0&&window.scrollY<lastScrollY&&setTimeout(()=>scan(!0),100),lastScrollY=window.scrollY},{passive:!0});const OrigImage=window.Image;window.Image=function(){const img=new OrigImage(...arguments);return img.src&&(img.src.includes('ggpht.com')||img.src.includes('googleusercontent.com'))&&img.addEventListener('load',()=>{isPostImage(img)&&setTimeout(()=>freezeImage(img),20)},{once:!0}),img},setTimeout(scan,400)}(),function(){function hardKill(video){if(video&&!video._hardKilled){video.pause(),video.muted=!0,video.volume=0;try{video.currentTime=0}catch(e){}try{video.srcObject=null}catch(e){}try{video.removeAttribute("src")}catch(e){}try{video.load()}catch(e){}video._hardKilled=!0}}function isMainPlayer(v){return!(!v.closest("ytd-watch-flexy")&&!v.classList.contains("html5-main-video"))}function scanAllVideos(){if(window.fsPause)return;document.querySelectorAll("video").forEach(v=>{const r=v.getBoundingClientRect();!(0===r.width||0===r.height||null===v.offsetParent)&&isMainPlayer(v)||hardKill(v)}),document.querySelectorAll("ytd-player").forEach(p=>{const sr=p.shadowRoot;sr&&sr.querySelectorAll("video").forEach(v=>{const r=v.getBoundingClientRect();!(0===r.width||0===r.height||null===v.offsetParent)&&isMainPlayer(v)||hardKill(v)})})}window.scanAllVideos=scanAllVideos,["AudioContext","webkitAudioContext"].forEach(name=>{if(!window[name])return;const AC=window[name];AC.prototype._patched||(AC.prototype._patched=!0,AC.prototype.createMediaElementSource=function(){return{connect(){},disconnect(){}}},AC.prototype.resume=()=>Promise.resolve())}),new MutationObserver(scanAllVideos).observe(document.documentElement,{childList:!0,subtree:!0}),setInterval(scanAllVideos,300)}(),function(){let fsPause=!1,fsTimer=null;function pauseBlocking(){fsPause=!0,fsTimer&&clearTimeout(fsTimer),fsTimer=setTimeout(()=>fsPause=!1,700)}document.addEventListener("fullscreenchange",pauseBlocking,!0),document.addEventListener("transitionstart",pauseBlocking,!0),document.addEventListener("transitionrun",pauseBlocking,!0);const origBlockAll=window.blockAll,origScanAllVideos=window.scanAllVideos;window.blockAll=function(){if(!fsPause)return origBlockAll.apply(this,arguments)},window.scanAllVideos=function(){if(!fsPause)return origScanAllVideos.apply(this,arguments)}}();
#+end_src
